# GitLab CI/CD for React Native Scaffolding
# Complete mirror of GitHub Actions workflows with ADVANCED CACHING
# Synced with PR #14 - All improvements included!

image: node:22-alpine

# Build configuration variables
variables:
  ANDROID_BUILD_TYPE: "debug"  # Can be overridden to "release"
  IOS_BUILD_TYPE: "debug"      # Can be overridden to "release"
  IOS_SIGNING: "unsigned"      # Can be overridden to "signed"
  EAS_PLATFORM: "all"          # Can be: all, android, ios
  EAS_PROFILE: "preview"       # Can be: development, preview, production
  EAS_BRANCH: "preview"        # For OTA updates
  
  # Gradle optimization
  GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

# Pipeline stages
stages:
  - test        # Lint, type-check, tests
  - build       # Web, Android, iOS builds
  - deploy      # EAS builds and updates

# ============================================
# REUSABLE TEMPLATES
# ============================================

# Cache configuration for pnpm
.cache_pnpm: &cache_pnpm
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store
  policy: pull

# Cache configuration for Gradle packages (FIXED - use file hash!)
.cache_gradle_packages: &cache_gradle_packages
  key:
    files:
      - android/build.gradle
      - android/app/build.gradle
      - android/gradle/wrapper/gradle-wrapper.properties
  paths:
    - .gradle/wrapper
    - .gradle/caches
    - .gradle/native
  policy: pull

# Cache configuration for Gradle build outputs (FIXED - use file hash!)
.cache_gradle_build: &cache_gradle_build
  key:
    files:
      - android/build.gradle
      - android/app/build.gradle
      - android/gradle/wrapper/gradle-wrapper.properties
  paths:
    - android/.gradle
    - android/app/build
    - android/build
  policy: pull

# Cache configuration for CocoaPods + SPM (ADVANCED)
.cache_cocoapods: &cache_cocoapods
  key: pods-v3-$CI_COMMIT_REF_SLUG
  paths:
    - ios/Pods
    - Library/Caches/CocoaPods
    - .cocoapods
  policy: pull

# pnpm setup script
.setup_pnpm: &setup_pnpm
  before_script:
    - echo "üîß Setting up pnpm..."
    - corepack enable
    - corepack prepare pnpm@10.23.0 --activate
    - pnpm config set store-dir .pnpm-store
    - echo "‚úÖ pnpm setup complete"

# ============================================
# TEST STAGE - FREE
# ============================================

ci:lint-and-test:
  stage: test
  <<: *setup_pnpm
  cache:
    - <<: *cache_pnpm
      policy: pull-push  # Write cache on test job
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üîç Verifying icon generation..."
    - |
      if [ ! -d "src/components/icons" ] || [ -z "$(ls -A src/components/icons 2>/dev/null)" ]; then
        echo "‚ùå ERROR - Icon generation failed!"
        exit 1
      fi
      echo "‚úÖ OK - Icons generated successfully"
      ls -la src/components/icons/ | head -20
    
    - echo "üîç Running linter..."
    - pnpm run lint
    
    - echo "üîç Running type check..."
    - pnpm run type-check
    
    - echo "üîç Checking code formatting..."
    - pnpm run format:check
    
    - echo "üß™ Running tests with coverage..."
    - pnpm run test:ci
    
    - echo "‚úÖ All checks passed!"
  
  artifacts:
    when: always
    reports:
      junit: coverage/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 7 days
  
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
  
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# ============================================
# BUILD STAGE - WEB (FREE)
# ============================================

build:web:
  stage: build
  <<: *setup_pnpm
  cache: *cache_pnpm
  
  needs:
    - ci:lint-and-test
  
  script:
    - echo "üåê Building web application..."
    - pnpm install --frozen-lockfile
    - pnpm run build:web
    
    - echo "‚úÖ OK - Web build completed"
    - echo "üì¶ Build size:"
    - du -sh dist/
    - echo ""
    - echo "üìÅ Build contents:"
    - ls -lh dist/ | head -20
  
  artifacts:
    name: "web-build-$CI_COMMIT_SHORT_SHA"
    paths:
      - dist/
    expire_in: 30 days
  
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: manual
      allow_failure: true
  
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# ============================================
# BUILD STAGE - ANDROID (FREE with ADVANCED CACHING)
# ============================================

build:android:debug:
  stage: build
  image: mingc/android-build-box:latest
  
  needs:
    - ci:lint-and-test
  
  cache:
    - <<: *cache_pnpm
    - <<: *cache_gradle_packages
      policy: pull-push
    - <<: *cache_gradle_build
      policy: pull-push
  
  variables:
    ANDROID_BUILD_TYPE: "debug"
  
  before_script:
    - echo "üîß Setting up Android build environment..."
    - corepack enable
    - corepack prepare pnpm@10.23.0 --activate
    - pnpm config set store-dir .pnpm-store
    - echo "‚úÖ Environment setup complete"
  
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üî® Prebuilding Android with Expo..."
    - pnpm run prebuild:android
    
    # ADVANCED: Enable Gradle performance features (no configuration cache - Expo incompatible)
    - echo "‚ö° Enabling Gradle performance optimizations..."
    - mkdir -p ~/.gradle
    - |
      cat >> ~/.gradle/gradle.properties << EOF
      # Enable Gradle build cache (reuse task outputs)
      org.gradle.caching=true
      
      # NOTE: Configuration cache disabled - not compatible with Expo/React Native
      # Expo uses Task.project during execution which breaks configuration cache
      
      # Parallel execution
      org.gradle.parallel=true
      
      # Configure daemon for CI
      org.gradle.daemon=true
      org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g -XX:+HeapDumpOnOutOfMemoryError
      
      # Use Kotlin incremental compilation
      kotlin.incremental=true
      kotlin.incremental.js=true
      
      # Enable Gradle configuration on demand
      org.gradle.configureondemand=true
      EOF
    - echo "‚úÖ Gradle performance features enabled!"
    
    - echo "üèóÔ∏è Building Android APK (Debug)..."
    - cd android
    - chmod +x gradlew
    - ./gradlew assembleDebug --build-cache --stacktrace --no-daemon
    - cd ..
    
    - echo "‚úÖ OK - Android Debug build completed"
    - echo "üì± PLATFORM - Android"
    - echo "üîß BUILD TYPE - Debug"
    - echo "üí∞ COST - FREE (GitLab CI minutes)"
    - echo "‚ö° CACHING - Advanced (Gradle cache + build outputs + parallel execution)"
    - echo "üì• INFO - Download APK from job artifacts"
  
  artifacts:
    name: "android-debug-$CI_COMMIT_SHORT_SHA"
    paths:
      - android/app/build/outputs/apk/debug/*.apk
    expire_in: 30 days
  
  rules:
    - when: manual
      allow_failure: true
  
  retry:
    max: 1
    when:
      - runner_system_failure

build:android:release:
  stage: build
  image: mingc/android-build-box:latest
  
  needs:
    - ci:lint-and-test
  
  cache:
    - <<: *cache_pnpm
    - <<: *cache_gradle_packages
      policy: pull-push
    - <<: *cache_gradle_build
      policy: pull-push
  
  variables:
    ANDROID_BUILD_TYPE: "release"
  
  before_script:
    - echo "üîß Setting up Android build environment..."
    - corepack enable
    - corepack prepare pnpm@10.23.0 --activate
    - pnpm config set store-dir .pnpm-store
    - echo "‚úÖ Environment setup complete"
  
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üî® Prebuilding Android with Expo..."
    - pnpm run prebuild:android
    
    # Configure Sentry AFTER prebuild (optional)
    - |
      if [ -n "$SENTRY_ORG" ] && [ -n "$SENTRY_PROJECT" ] && [ -n "$SENTRY_AUTH_TOKEN" ]; then
        echo "üìù Creating sentry.properties for Android..."
        cat > android/sentry.properties << EOF
      defaults.url=https://sentry.io/
      defaults.org=$SENTRY_ORG
      defaults.project=$SENTRY_PROJECT
      auth.token=$SENTRY_AUTH_TOKEN
      EOF
        echo "‚úÖ Sentry configured for Android sourcemap upload"
      else
        echo "‚ö†Ô∏è  Sentry secrets not configured - skipping Sentry setup"
        echo "‚ÑπÔ∏è  Build will complete without source map upload"
      fi
    
    # ADVANCED: Enable Gradle performance features
    - echo "‚ö° Enabling Gradle performance optimizations..."
    - mkdir -p ~/.gradle
    - |
      cat >> ~/.gradle/gradle.properties << EOF
      org.gradle.caching=true
      org.gradle.parallel=true
      org.gradle.daemon=true
      org.gradle.jvmargs=-Xmx4g -XX:MaxMetaspaceSize=1g
      kotlin.incremental=true
      kotlin.incremental.js=true
      org.gradle.configureondemand=true
      EOF
    - echo "‚úÖ Gradle optimizations enabled!"
    
    - echo "üèóÔ∏è Building Android APK + AAB (Release)..."
    - cd android
    - chmod +x gradlew
    - ./gradlew assembleRelease bundleRelease --build-cache --stacktrace --no-daemon
    - cd ..
    
    - echo "‚úÖ OK - Android Release build completed"
    - echo "üì± PLATFORM - Android"
    - echo "üîß BUILD TYPE - Release"
    - echo "üí∞ COST - FREE (GitLab CI minutes)"
    - echo "‚ö° CACHING - Advanced (40-50% faster)"
    - echo "üì• INFO - Download APK/AAB from job artifacts"
  
  artifacts:
    name: "android-release-$CI_COMMIT_SHORT_SHA"
    paths:
      - android/app/build/outputs/apk/release/*.apk
      - android/app/build/outputs/bundle/release/*.aab
    expire_in: 30 days
  
  rules:
    - if: $ANDROID_KEYSTORE_BASE64 && $KEYSTORE_PASSWORD
      when: manual
      allow_failure: true
  
  retry:
    max: 1
    when:
      - runner_system_failure

# ============================================
# BUILD STAGE - iOS (Requires macOS runner with ADVANCED CACHING)
# ============================================

build:ios:debug:
  stage: build
  tags:
    - macos
    - xcode
  
  needs:
    - ci:lint-and-test
  
  cache:
    - <<: *cache_pnpm
    - <<: *cache_cocoapods
      policy: pull-push
    # ADVANCED: Cache ccache
    - key: ccache-$CI_COMMIT_REF_SLUG
      paths:
        - Library/Caches/ccache
      policy: pull-push
    # ADVANCED: Cache DerivedData
    - key: deriveddata-v2-$CI_COMMIT_REF_SLUG
      paths:
        - Library/Developer/Xcode/DerivedData
      policy: pull-push
    # ADVANCED: Cache SPM
    - key: spm-$CI_COMMIT_REF_SLUG
      paths:
        - ios/SourcePackages
      policy: pull-push
  
  variables:
    IOS_BUILD_TYPE: "debug"
  
  before_script:
    - echo "üîß Setting up iOS build environment..."
    - corepack enable
    - corepack prepare pnpm@10.23.0 --activate
    - pnpm config set store-dir .pnpm-store
    
    # ADVANCED: Install and configure ccache
    - echo "üì¶ Installing ccache for C++ compilation caching..."
    - brew install ccache || echo "ccache already installed"
    - ccache --version
    - ccache --max-size=2G
    - ccache --set-config=compression=true
    - ccache --set-config=sloppiness=file_macro,time_macros,include_file_mtime,include_file_ctime
    - ccache --zero-stats
    - echo "‚úÖ ccache configured!"
    
    # ADVANCED: Create ccache wrapper scripts
    - echo "üîß Creating ccache wrapper scripts..."
    - |
      cat > /usr/local/bin/ccache-clang << 'EOF'
      #!/bin/bash
      exec ccache clang "$@"
      EOF
      
      cat > /usr/local/bin/ccache-clang++ << 'EOF'
      #!/bin/bash
      exec ccache clang++ "$@"
      EOF
      
      chmod +x /usr/local/bin/ccache-clang
      chmod +x /usr/local/bin/ccache-clang++
    - echo "‚úÖ ccache wrappers created!"
    
    - echo "‚úÖ Environment setup complete"
  
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üî® Prebuilding iOS with Expo..."
    - pnpm dlx expo prebuild --platform ios --clean
    
    - echo "üèóÔ∏è Building iOS (Debug) with advanced caching..."
    - cd ios
    
    # Detect project structure
    - |
      if [ -d *.xcworkspace ]; then
        WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -n 1 | sed 's|./||')
        SCHEME=$(basename "$WORKSPACE" .xcworkspace)
        echo "‚úÖ Found workspace: $WORKSPACE"
        echo "‚úÖ Using scheme: $SCHEME"
        
        xcodebuild \
          -workspace "$WORKSPACE" \
          -scheme "$SCHEME" \
          -configuration Debug \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          -derivedDataPath build \
          CODE_SIGNING_ALLOWED=NO \
          COMPILER_INDEX_STORE_ENABLE=NO \
          CLANG_ENABLE_EXPLICIT_MODULES=NO \
          CC=ccache-clang \
          CXX=ccache-clang++ \
          CCACHE_DIR="$HOME/Library/Caches/ccache"
      else
        PROJECT=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -n 1 | sed 's|./||')
        SCHEME=$(basename "$PROJECT" .xcodeproj)
        echo "‚úÖ Found project: $PROJECT"
        echo "‚úÖ Using scheme: $SCHEME"
        
        xcodebuild \
          -project "$PROJECT" \
          -scheme "$SCHEME" \
          -configuration Debug \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          -derivedDataPath build \
          CODE_SIGNING_ALLOWED=NO \
          COMPILER_INDEX_STORE_ENABLE=NO \
          CLANG_ENABLE_EXPLICIT_MODULES=NO \
          CC=ccache-clang \
          CXX=ccache-clang++ \
          CCACHE_DIR="$HOME/Library/Caches/ccache"
      fi
    
    - echo ""
    - echo "‚úÖ iOS Debug build completed!"
    - echo "üìä ccache statistics:"
    - ccache -s
    
    - cd ..
    - echo "üì± PLATFORM - iOS"
    - echo "üîß BUILD TYPE - Debug"
    - echo "üí∞ COST - Requires macOS runner"
    - echo "‚ö° CACHING - Advanced (DerivedData + CocoaPods + SPM + ccache)"
    - echo "üì• OUTPUT - Debug .app for simulator"
  
  artifacts:
    name: "ios-debug-$CI_COMMIT_SHORT_SHA"
    paths:
      - ios/build/Build/Products/Debug-iphonesimulator/*.app
    expire_in: 30 days
  
  rules:
    - when: manual
      allow_failure: true
  
  retry:
    max: 1
    when:
      - runner_system_failure

build:ios:release:unsigned:
  stage: build
  tags:
    - macos
    - xcode
  
  needs:
    - ci:lint-and-test
  
  cache:
    - <<: *cache_pnpm
    - <<: *cache_cocoapods
      policy: pull-push
    - key: ccache-$CI_COMMIT_REF_SLUG
      paths:
        - Library/Caches/ccache
      policy: pull-push
    - key: deriveddata-v2-$CI_COMMIT_REF_SLUG
      paths:
        - Library/Developer/Xcode/DerivedData
      policy: pull-push
    - key: spm-$CI_COMMIT_REF_SLUG
      paths:
        - ios/SourcePackages
      policy: pull-push
  
  variables:
    IOS_BUILD_TYPE: "release"
    IOS_SIGNING: "unsigned"
  
  before_script:
    - echo "üîß Setting up iOS build environment..."
    - corepack enable
    - corepack prepare pnpm@10.23.0 --activate
    - pnpm config set store-dir .pnpm-store
    
    # Install ccache
    - brew install ccache || echo "ccache already installed"
    - ccache --version
    - ccache --max-size=2G
    - ccache --set-config=compression=true
    - ccache --set-config=sloppiness=file_macro,time_macros,include_file_mtime,include_file_ctime
    - ccache --zero-stats
    
    # Create ccache wrappers
    - |
      cat > /usr/local/bin/ccache-clang << 'EOF'
      #!/bin/bash
      exec ccache clang "$@"
      EOF
      
      cat > /usr/local/bin/ccache-clang++ << 'EOF'
      #!/bin/bash
      exec ccache clang++ "$@"
      EOF
      
      chmod +x /usr/local/bin/ccache-clang
      chmod +x /usr/local/bin/ccache-clang++
    
    - echo "‚úÖ Environment setup complete"
  
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üî® Prebuilding iOS with Expo..."
    - pnpm dlx expo prebuild --platform ios --clean
    
    # Configure Sentry AFTER prebuild (optional)
    - |
      if [ -n "$SENTRY_ORG" ] && [ -n "$SENTRY_PROJECT" ] && [ -n "$SENTRY_AUTH_TOKEN" ]; then
        echo "üìù Creating sentry.properties for iOS..."
        cat > ios/sentry.properties << EOF
      defaults.url=https://sentry.io/
      defaults.org=$SENTRY_ORG
      defaults.project=$SENTRY_PROJECT
      auth.token=$SENTRY_AUTH_TOKEN
      EOF
        echo "‚úÖ Sentry configured for iOS sourcemap upload"
      else
        echo "‚ö†Ô∏è  Sentry secrets not configured - skipping Sentry setup"
      fi
    
    - echo "üèóÔ∏è Building iOS Release (UNSIGNED) with advanced caching..."
    - cd ios
    
    # Detect and build
    - |
      if [ -d *.xcworkspace ]; then
        WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -n 1 | sed 's|./||')
        SCHEME=$(basename "$WORKSPACE" .xcworkspace)
        
        xcodebuild \
          -workspace "$WORKSPACE" \
          -scheme "$SCHEME" \
          -configuration Release \
          -sdk iphoneos \
          -archivePath build/$SCHEME.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          COMPILER_INDEX_STORE_ENABLE=NO \
          CLANG_ENABLE_EXPLICIT_MODULES=NO \
          CC=ccache-clang \
          CXX=ccache-clang++ \
          CCACHE_DIR="$HOME/Library/Caches/ccache"
      else
        PROJECT=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -n 1 | sed 's|./||')
        SCHEME=$(basename "$PROJECT" .xcodeproj)
        
        xcodebuild \
          -project "$PROJECT" \
          -scheme "$SCHEME" \
          -configuration Release \
          -sdk iphoneos \
          -archivePath build/$SCHEME.xcarchive \
          archive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          COMPILER_INDEX_STORE_ENABLE=NO \
          CLANG_ENABLE_EXPLICIT_MODULES=NO \
          CC=ccache-clang \
          CXX=ccache-clang++ \
          CCACHE_DIR="$HOME/Library/Caches/ccache"
      fi
    
    - echo ""
    - echo "‚úÖ iOS unsigned archive created!"
    - echo "üìä ccache statistics:"
    - ccache -s
    
    - cd ..
    - echo "üì± PLATFORM - iOS"
    - echo "üîß BUILD TYPE - Release (Unsigned)"
    - echo "üí∞ COST - Requires macOS runner"
    - echo "‚ö° CACHING - Advanced (50-60% faster)"
    - echo "üì¶ OUTPUT - Unsigned .xcarchive"
    - echo "‚ÑπÔ∏è  NOTE - Use signed build when you have Apple Developer account"
  
  artifacts:
    name: "ios-release-unsigned-$CI_COMMIT_SHORT_SHA"
    paths:
      - ios/build/*.xcarchive
    expire_in: 30 days
  
  rules:
    - when: manual
      allow_failure: true
  
  retry:
    max: 1
    when:
      - runner_system_failure

build:ios:release:signed:
  stage: build
  tags:
    - macos
    - xcode
  
  needs:
    - ci:lint-and-test
  
  cache:
    - <<: *cache_pnpm
    - <<: *cache_cocoapods
      policy: pull-push
    - key: ccache-$CI_COMMIT_REF_SLUG
      paths:
        - Library/Caches/ccache
      policy: pull-push
    - key: deriveddata-v2-$CI_COMMIT_REF_SLUG
      paths:
        - Library/Developer/Xcode/DerivedData
      policy: pull-push
    - key: spm-$CI_COMMIT_REF_SLUG
      paths:
        - ios/SourcePackages
      policy: pull-push
  
  variables:
    IOS_BUILD_TYPE: "release"
    IOS_SIGNING: "signed"
  
  before_script:
    - echo "üîß Setting up iOS build environment..."
    - corepack enable
    - corepack prepare pnpm@10.23.0 --activate
    - pnpm config set store-dir .pnpm-store
    
    # Check signing requirements
    - |
      if [ -z "$APPLE_CERTIFICATE_BASE64" ]; then
        echo "‚ùå ERROR: APPLE_CERTIFICATE_BASE64 secret not configured!"
        echo ""
        echo "To use signed builds, configure these secrets in GitLab:"
        echo "  1. APPLE_CERTIFICATE_BASE64 - Your .p12 certificate (base64)"
        echo "  2. APPLE_CERTIFICATE_PASSWORD - Certificate password"
        echo "  3. APPLE_PROVISIONING_PROFILE_BASE64 - Provisioning profile (base64)"
        echo "  4. APPLE_TEAM_ID - Your Apple Developer Team ID"
        exit 1
      fi
    
    # Import certificate and provisioning profile
    - echo "üîê Importing signing certificate..."
    - KEYCHAIN_PATH=$CI_PROJECT_DIR/app-signing.keychain-db
    - KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
    - security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
    - security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
    - security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
    - echo "$APPLE_CERTIFICATE_BASE64" | base64 --decode > certificate.p12
    - security import certificate.p12 -k $KEYCHAIN_PATH -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
    - security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
    - security list-keychain -d user -s $KEYCHAIN_PATH
    - mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
    - echo "$APPLE_PROVISIONING_PROFILE_BASE64" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/profile.mobileprovision
    - echo "‚úÖ Certificate and provisioning profile imported!"
    
    # Install ccache
    - brew install ccache || echo "ccache already installed"
    - ccache --max-size=2G
    - ccache --set-config=compression=true
    - ccache --zero-stats
    
    # Create ccache wrappers
    - |
      cat > /usr/local/bin/ccache-clang << 'EOF'
      #!/bin/bash
      exec ccache clang "$@"
      EOF
      
      cat > /usr/local/bin/ccache-clang++ << 'EOF'
      #!/bin/bash
      exec ccache clang++ "$@"
      EOF
      
      chmod +x /usr/local/bin/ccache-clang
      chmod +x /usr/local/bin/ccache-clang++
    
    - echo "‚úÖ Environment setup complete"
  
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üî® Prebuilding iOS with Expo..."
    - pnpm dlx expo prebuild --platform ios --clean
    
    # Configure Sentry AFTER prebuild
    - |
      if [ -n "$SENTRY_ORG" ] && [ -n "$SENTRY_PROJECT" ] && [ -n "$SENTRY_AUTH_TOKEN" ]; then
        echo "üìù Creating sentry.properties for iOS..."
        cat > ios/sentry.properties << EOF
      defaults.url=https://sentry.io/
      defaults.org=$SENTRY_ORG
      defaults.project=$SENTRY_PROJECT
      auth.token=$SENTRY_AUTH_TOKEN
      EOF
      fi
    
    # Create ExportOptions.plist
    - echo "üìù Creating ExportOptions.plist for signed IPA export..."
    - |
      cat > ios/ExportOptions.plist << 'EOF'
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
      	<key>method</key>
      	<string>app-store</string>
      	<key>teamID</key>
      	<string>${APPLE_TEAM_ID}</string>
      	<key>uploadBitcode</key>
      	<false/>
      	<key>uploadSymbols</key>
      	<true/>
      	<key>compileBitcode</key>
      	<false/>
      </dict>
      </plist>
      EOF
    
    - echo "üèóÔ∏è Building iOS Release (SIGNED)..."
    - cd ios
    
    # Build and archive
    - |
      if [ -d *.xcworkspace ]; then
        WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -n 1 | sed 's|./||')
        SCHEME=$(basename "$WORKSPACE" .xcworkspace)
        
        xcodebuild \
          -workspace "$WORKSPACE" \
          -scheme "$SCHEME" \
          -configuration Release \
          -sdk iphoneos \
          -archivePath build/$SCHEME.xcarchive \
          archive \
          DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
          COMPILER_INDEX_STORE_ENABLE=NO \
          CLANG_ENABLE_EXPLICIT_MODULES=NO \
          CC=ccache-clang \
          CXX=ccache-clang++ \
          CCACHE_DIR="$HOME/Library/Caches/ccache"
      else
        PROJECT=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -n 1 | sed 's|./||')
        SCHEME=$(basename "$PROJECT" .xcodeproj)
        
        xcodebuild \
          -project "$PROJECT" \
          -scheme "$SCHEME" \
          -configuration Release \
          -sdk iphoneos \
          -archivePath build/$SCHEME.xcarchive \
          archive \
          DEVELOPMENT_TEAM="$APPLE_TEAM_ID" \
          COMPILER_INDEX_STORE_ENABLE=NO \
          CLANG_ENABLE_EXPLICIT_MODULES=NO \
          CC=ccache-clang \
          CXX=ccache-clang++ \
          CCACHE_DIR="$HOME/Library/Caches/ccache"
      fi
    
    # Export IPA
    - echo "üì¶ Exporting signed IPA for App Store..."
    - |
      if [ -d *.xcworkspace ]; then
        WORKSPACE=$(find . -maxdepth 1 -name "*.xcworkspace" -type d | head -n 1 | sed 's|./||')
        SCHEME=$(basename "$WORKSPACE" .xcworkspace)
      else
        PROJECT=$(find . -maxdepth 1 -name "*.xcodeproj" -type d | head -n 1 | sed 's|./||')
        SCHEME=$(basename "$PROJECT" .xcodeproj)
      fi
      
      xcodebuild -exportArchive \
        -archivePath build/$SCHEME.xcarchive \
        -exportPath build \
        -exportOptionsPlist ExportOptions.plist
    
    - echo ""
    - echo "‚úÖ iOS signed IPA exported!"
    - echo "üìä ccache statistics:"
    - ccache -s
    
    - cd ..
    - echo "üì± PLATFORM - iOS"
    - echo "üîß BUILD TYPE - Release (Signed)"
    - echo "üîê SIGNING - Signed with Apple Developer certificate"
    - echo "üí∞ COST - Requires macOS runner"
    - echo "‚ö° CACHING - Advanced (50-60% faster)"
    - echo "üì¶ OUTPUT - Signed IPA ready for App Store"
    - echo "‚úÖ PRODUCTION READY - Can upload to TestFlight/App Store"
  
  artifacts:
    name: "ios-release-signed-$CI_COMMIT_SHORT_SHA"
    paths:
      - ios/build/*.ipa
    expire_in: 30 days
  
  rules:
    - if: $APPLE_CERTIFICATE_BASE64 && $APPLE_TEAM_ID
      when: manual
      allow_failure: true
  
  after_script:
    - |
      if [ -f "$CI_PROJECT_DIR/app-signing.keychain-db" ]; then
        security delete-keychain $CI_PROJECT_DIR/app-signing.keychain-db
      fi
  
  retry:
    max: 1
    when:
      - runner_system_failure

# ============================================
# DEPLOY STAGE - EAS BUILD (Requires subscription)
# ============================================

build:eas:
  stage: deploy
  <<: *setup_pnpm
  cache: *cache_pnpm
  
  needs:
    - ci:lint-and-test
  
  variables:
    EAS_PLATFORM: "all"     # Override with: android, ios, all
    EAS_PROFILE: "preview"  # Override with: development, preview, production
  
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üîß Installing EAS CLI..."
    - pnpm add -g eas-cli
    
    - echo "üöÄ Triggering EAS Build..."
    - |
      eas build \
        --platform $EAS_PLATFORM \
        --profile $EAS_PROFILE \
        --non-interactive \
        --no-wait
    
    - echo "‚úÖ OK - EAS Build triggered successfully"
    - echo "üì± PLATFORM - $EAS_PLATFORM"
    - echo "üîß PROFILE - $EAS_PROFILE"
    - echo "üí∞ COST - Using paid EAS Build subscription"
    - echo "üîî INFO - Check build status at https://expo.dev"
  
  rules:
    - if: $EXPO_TOKEN
      when: manual
      allow_failure: true
  
  retry:
    max: 1
    when:
      - script_failure

# ============================================
# DEPLOY STAGE - EAS UPDATE (OTA - FREE)
# ============================================

update:eas:
  stage: deploy
  <<: *setup_pnpm
  cache: *cache_pnpm
  
  needs:
    - ci:lint-and-test
  
  variables:
    EAS_BRANCH: "preview"                          # Override with branch name
    UPDATE_MESSAGE: "OTA update from GitLab CI"    # Override with custom message
  
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üîß Installing EAS CLI..."
    - pnpm add -g eas-cli
    
    - echo "üöÄ Publishing EAS Update..."
    - |
      eas update \
        --branch $EAS_BRANCH \
        --message "$UPDATE_MESSAGE" \
        --non-interactive
    
    - echo "‚úÖ OK - EAS Update published successfully"
    - echo "üåø BRANCH - $EAS_BRANCH"
    - echo "üí∞ COST - FREE (OTA updates are free)"
    - echo "üì± INFO - Users will receive update on next app launch"
  
  rules:
    - if: $EXPO_TOKEN && $CI_COMMIT_BRANCH == "main"
    - if: $EXPO_TOKEN
      when: manual
      allow_failure: true
  
  retry:
    max: 2
    when:
      - script_failure

# ============================================
# WORKFLOW SUMMARY
# ============================================
# 
# ‚úÖ PARITY ACHIEVED with GitHub Actions PR #14!
# 
# TEST STAGE (Always runs on MR/main/develop):
#   ‚úÖ ci:lint-and-test - Lint, type-check, format, tests
# 
# BUILD STAGE (Manual or auto on main):
#   ‚úÖ build:web - Static web export (FREE)
#   ‚úÖ build:android:debug - Android Debug APK (FREE, ADVANCED CACHING)
#   ‚úÖ build:android:release - Android Release APK/AAB (FREE, ADVANCED CACHING)
#   ‚úÖ build:ios:debug - iOS Debug build (macOS runner, ADVANCED CACHING)
#   ‚úÖ build:ios:release:unsigned - iOS unsigned archive (macOS runner, ADVANCED CACHING)
#   ‚úÖ build:ios:release:signed - iOS signed IPA (macOS runner, ADVANCED CACHING)
# 
# DEPLOY STAGE (Manual or conditional):
#   ‚úÖ build:eas - EAS Build (requires EXPO_TOKEN)
#   ‚úÖ update:eas - EAS Update OTA (auto on main if EXPO_TOKEN)
# 
# üéâ NEW FEATURES (from GitHub Actions PR #14):
#   ‚ö° Android: Gradle build cache + parallel execution (40-50% faster)
#   ‚ö° iOS: ccache + DerivedData + CocoaPods + SPM caching (50-60% faster)
#   üîß ccache wrapper scripts (fixes spawn error)
#   üîß CLANG_ENABLE_EXPLICIT_MODULES=NO (ccache compatibility)
#   üîß Dynamic project/workspace detection
#   üîß Optional Sentry configuration (graceful degradation)
#   üîß Separate signed/unsigned iOS workflows
#   üîß ExportOptions.plist generated dynamically
#   üîß Expo prebuild for native project generation
#   üîß Modern iOS/Android build approach (2025 best practices)
# 
# REQUIRED SECRETS:
#   - EXPO_TOKEN (for EAS builds/updates)
#   - SENTRY_ORG, SENTRY_PROJECT, SENTRY_AUTH_TOKEN (optional)
#   - ANDROID_KEYSTORE_BASE64, KEYSTORE_PASSWORD, KEY_ALIAS, KEY_PASSWORD (for release)
#   - APPLE_CERTIFICATE_BASE64, APPLE_CERTIFICATE_PASSWORD (for iOS signed)
#   - APPLE_PROVISIONING_PROFILE_BASE64, APPLE_TEAM_ID (for iOS signed)
# 
# ============================================
