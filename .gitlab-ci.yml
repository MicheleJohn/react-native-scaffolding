# GitLab CI/CD for React Native Scaffolding
# Complete mirror of GitHub Actions workflows (excluding mirror-to-gitlab)
# Free tier compatible with manual triggers for expensive jobs

image: node:22-alpine

# Workflow control - Define what runs when
variables:
  # Build configuration
  ANDROID_BUILD_TYPE: "debug"  # Can be overridden to "release"
  IOS_BUILD_TYPE: "debug"      # Can be overridden to "release"
  EAS_PLATFORM: "all"          # Can be: all, android, ios
  EAS_PROFILE: "preview"       # Can be: development, preview, production
  EAS_BRANCH: "preview"        # For OTA updates
  
  # Cache configuration
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.caching=true"
  GRADLE_USER_HOME: "$CI_PROJECT_DIR/.gradle"

# Pipeline stages
stages:
  - test        # Lint, type-check, tests
  - build       # Web, Android, iOS builds
  - deploy      # EAS builds and updates

# ============================================
# REUSABLE TEMPLATES
# ============================================

# Cache configuration for pnpm
.cache_pnpm: &cache_pnpm
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store
  policy: pull

# Cache configuration for Gradle
.cache_gradle: &cache_gradle
  key: gradle-$CI_COMMIT_REF_SLUG
  paths:
    - .gradle/wrapper
    - .gradle/caches
  policy: pull

# Cache configuration for CocoaPods
.cache_cocoapods: &cache_cocoapods
  key: cocoapods-$CI_COMMIT_REF_SLUG
  paths:
    - ios/Pods
  policy: pull

# pnpm setup script
.setup_pnpm: &setup_pnpm
  before_script:
    - echo "üîß Setting up pnpm..."
    - corepack enable
    - corepack prepare pnpm@10.23.0 --activate
    - pnpm config set store-dir .pnpm-store
    - echo "‚úÖ pnpm setup complete"

# ============================================
# TEST STAGE - FREE
# ============================================

ci:lint-and-test:
  stage: test
  <<: *setup_pnpm
  cache:
    - <<: *cache_pnpm
      policy: pull-push  # Write cache on test job
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üîç Verifying icon generation..."
    - |
      if [ ! -d "src/components/icons" ] || [ -z "$(ls -A src/components/icons 2>/dev/null)" ]; then
        echo "‚ùå ERROR - Icon generation failed!"
        exit 1
      fi
      echo "‚úÖ OK - Icons generated successfully"
      ls -la src/components/icons/ | head -20
    
    - echo "üîç Running linter..."
    - pnpm run lint
    
    - echo "üîç Running type check..."
    - pnpm run type-check
    
    - echo "üîç Checking code formatting..."
    - pnpm run format:check
    
    - echo "üß™ Running tests with coverage..."
    - pnpm run test:ci
    
    - echo "‚úÖ All checks passed!"
  
  artifacts:
    when: always
    reports:
      junit: coverage/junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 7 days
  
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  
  rules:
    # Run on merge requests
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    # Run on main/develop branches
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"
  
  # Allow job to be retried
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# ============================================
# BUILD STAGE - WEB (FREE)
# ============================================

build:web:
  stage: build
  <<: *setup_pnpm
  cache: *cache_pnpm
  
  needs:
    - ci:lint-and-test
  
  script:
    - echo "üåê Building web application..."
    - pnpm install --frozen-lockfile
    - pnpm run build:web
    
    - echo "‚úÖ OK - Web build completed"
    - echo "üì¶ Build size:"
    - du -sh dist/
    - echo ""
    - echo "üìÅ Build contents:"
    - ls -lh dist/ | head -20
  
  artifacts:
    name: "web-build-$CI_COMMIT_SHORT_SHA"
    paths:
      - dist/
    expire_in: 30 days
  
  rules:
    # Auto-run on main branch
    - if: $CI_COMMIT_BRANCH == "main"
    # Manual trigger on other branches
    - when: manual
      allow_failure: true
  
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure

# ============================================
# BUILD STAGE - ANDROID (FREE but uses minutes)
# ============================================

build:android:debug:
  stage: build
  image: mingc/android-build-box:latest
  
  needs:
    - ci:lint-and-test
  
  cache:
    - <<: *cache_pnpm
    - <<: *cache_gradle
      policy: pull-push
  
  variables:
    ANDROID_BUILD_TYPE: "debug"
  
  before_script:
    - echo "üîß Setting up Android build environment..."
    - corepack enable
    - corepack prepare pnpm@10.23.0 --activate
    - pnpm config set store-dir .pnpm-store
    - echo "‚úÖ Environment setup complete"
  
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üî® Prebuilding Android with Expo..."
    - pnpm run prebuild:android
    
    - echo "üèóÔ∏è Building Android APK (Debug)..."
    - cd android
    - chmod +x gradlew
    - ./gradlew assembleDebug --stacktrace --no-daemon
    - cd ..
    
    - echo "‚úÖ OK - Android Debug build completed"
    - echo "üì± PLATFORM - Android"
    - echo "üîß BUILD TYPE - Debug"
    - echo "üí∞ COST - FREE (GitLab CI minutes)"
    - echo "üì• INFO - Download APK from job artifacts"
  
  artifacts:
    name: "android-debug-$CI_COMMIT_SHORT_SHA"
    paths:
      - android/app/build/outputs/apk/debug/*.apk
    expire_in: 30 days
  
  rules:
    - when: manual
      allow_failure: true
  
  retry:
    max: 1
    when:
      - runner_system_failure

build:android:release:
  stage: build
  image: mingc/android-build-box:latest
  
  needs:
    - ci:lint-and-test
  
  cache:
    - <<: *cache_pnpm
    - <<: *cache_gradle
      policy: pull-push
  
  variables:
    ANDROID_BUILD_TYPE: "release"
  
  before_script:
    - echo "üîß Setting up Android build environment..."
    - corepack enable
    - corepack prepare pnpm@10.23.0 --activate
    - pnpm config set store-dir .pnpm-store
    
    # Configure Sentry for release build (if secrets available)
    - |
      if [ -n "$SENTRY_ORG" ] && [ -n "$SENTRY_PROJECT" ] && [ -n "$SENTRY_AUTH_TOKEN" ]; then
        echo "üîê Configuring Sentry for sourcemap upload..."
        cat > android/sentry.properties << EOF
      defaults.url=https://sentry.io/
      defaults.org=$SENTRY_ORG
      defaults.project=$SENTRY_PROJECT
      auth.token=$SENTRY_AUTH_TOKEN
      EOF
        echo "‚úÖ Sentry configured"
      else
        echo "‚ö†Ô∏è Sentry secrets not configured - skipping sourcemap upload"
      fi
    
    - echo "‚úÖ Environment setup complete"
  
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üî® Prebuilding Android with Expo..."
    - pnpm run prebuild:android
    
    - echo "üèóÔ∏è Building Android APK (Release)..."
    - cd android
    - chmod +x gradlew
    - ./gradlew assembleRelease --stacktrace --no-daemon
    - cd ..
    
    - echo "‚úÖ OK - Android Release build completed"
    - echo "üì± PLATFORM - Android"
    - echo "üîß BUILD TYPE - Release"
    - echo "üí∞ COST - FREE (GitLab CI minutes)"
    - echo "üì• INFO - Download APK from job artifacts"
  
  artifacts:
    name: "android-release-$CI_COMMIT_SHORT_SHA"
    paths:
      - android/app/build/outputs/apk/release/*.apk
      - android/app/build/outputs/bundle/release/*.aab
    expire_in: 30 days
  
  rules:
    # Only allow if keystore secrets are configured
    - if: $ANDROID_KEYSTORE_BASE64 && $KEYSTORE_PASSWORD
      when: manual
      allow_failure: true
  
  retry:
    max: 1
    when:
      - runner_system_failure

# ============================================
# BUILD STAGE - iOS (Requires macOS runner)
# ============================================

build:ios:debug:
  stage: build
  # NOTE: Requires macOS runner with Xcode
  # Free tier GitLab doesn't provide macOS runners
  tags:
    - macos
    - xcode
  
  needs:
    - ci:lint-and-test
  
  cache:
    - <<: *cache_pnpm
    - <<: *cache_cocoapods
      policy: pull-push
  
  variables:
    IOS_BUILD_TYPE: "debug"
  
  before_script:
    - echo "üîß Setting up iOS build environment..."
    - corepack enable
    - corepack prepare pnpm@10.23.0 --activate
    - pnpm config set store-dir .pnpm-store
    - echo "‚úÖ Environment setup complete"
  
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üî® Prebuilding iOS with Expo..."
    - pnpm dlx expo prebuild --platform ios --non-interactive
    
    - echo "üì¶ Installing CocoaPods dependencies..."
    - cd ios
    - pod install
    
    - echo "üîç Detecting workspace and scheme..."
    - export WORKSPACE=$(ls -1 *.xcworkspace | head -n 1)
    - export SCHEME=$(basename "$WORKSPACE" .xcworkspace)
    - echo "‚úÖ Detected - Workspace: $WORKSPACE, Scheme: $SCHEME"
    
    - echo "üèóÔ∏è Building iOS (Debug)..."
    - |
      xcodebuild -workspace "$WORKSPACE" \
        -scheme "$SCHEME" \
        -configuration Debug \
        -sdk iphonesimulator \
        -derivedDataPath build \
        CODE_SIGNING_ALLOWED=NO \
        -quiet
    - cd ..
    
    - echo "‚úÖ OK - iOS Debug build completed"
    - echo "üì± PLATFORM - iOS"
    - echo "üîß BUILD TYPE - Debug"
    - echo "üí∞ COST - Requires macOS runner"
  
  artifacts:
    name: "ios-debug-$CI_COMMIT_SHORT_SHA"
    paths:
      - ios/build/Build/Products/Debug-iphonesimulator/*.app
    expire_in: 30 days
  
  rules:
    - when: manual
      allow_failure: true
  
  retry:
    max: 1
    when:
      - runner_system_failure

build:ios:release:
  stage: build
  tags:
    - macos
    - xcode
  
  needs:
    - ci:lint-and-test
  
  cache:
    - <<: *cache_pnpm
    - <<: *cache_cocoapods
      policy: pull-push
  
  variables:
    IOS_BUILD_TYPE: "release"
  
  before_script:
    - echo "üîß Setting up iOS build environment..."
    - corepack enable
    - corepack prepare pnpm@10.23.0 --activate
    - pnpm config set store-dir .pnpm-store
    - echo "‚úÖ Environment setup complete"
  
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üî® Prebuilding iOS with Expo..."
    - pnpm dlx expo prebuild --platform ios --non-interactive
    
    - echo "üì¶ Installing CocoaPods dependencies..."
    - cd ios
    - pod install
    
    - echo "üîç Detecting workspace and scheme..."
    - export WORKSPACE=$(ls -1 *.xcworkspace | head -n 1)
    - export SCHEME=$(basename "$WORKSPACE" .xcworkspace)
    - echo "‚úÖ Detected - Workspace: $WORKSPACE, Scheme: $SCHEME"
    
    - echo "üèóÔ∏è Building iOS Archive (Release)..."
    - |
      xcodebuild -workspace "$WORKSPACE" \
        -scheme "$SCHEME" \
        -configuration Release \
        -archivePath build/App.xcarchive \
        archive \
        -quiet
    
    - echo "üì¶ Exporting IPA..."
    - |
      xcodebuild -exportArchive \
        -archivePath build/App.xcarchive \
        -exportPath build \
        -exportOptionsPlist ExportOptions.plist \
        -quiet
    - cd ..
    
    - echo "‚úÖ OK - iOS Release build completed"
    - echo "üì± PLATFORM - iOS"
    - echo "üîß BUILD TYPE - Release"
    - echo "üí∞ COST - Requires macOS runner"
    - echo "üì• INFO - Download IPA from job artifacts"
  
  artifacts:
    name: "ios-release-$CI_COMMIT_SHORT_SHA"
    paths:
      - ios/build/*.ipa
    expire_in: 30 days
  
  rules:
    - if: $MATCH_PASSWORD && $FASTLANE_USER
      when: manual
      allow_failure: true
  
  retry:
    max: 1
    when:
      - runner_system_failure

# ============================================
# DEPLOY STAGE - EAS BUILD (Requires subscription)
# ============================================

build:eas:
  stage: deploy
  <<: *setup_pnpm
  cache: *cache_pnpm
  
  needs:
    - ci:lint-and-test
  
  variables:
    EAS_PLATFORM: "all"     # Override with: android, ios, all
    EAS_PROFILE: "preview"  # Override with: development, preview, production
  
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üîß Installing EAS CLI..."
    - pnpm add -g eas-cli
    
    - echo "üöÄ Triggering EAS Build..."
    - |
      eas build \
        --platform $EAS_PLATFORM \
        --profile $EAS_PROFILE \
        --non-interactive \
        --no-wait
    
    - echo "‚úÖ OK - EAS Build triggered successfully"
    - echo "üì± PLATFORM - $EAS_PLATFORM"
    - echo "üîß PROFILE - $EAS_PROFILE"
    - echo "üí∞ COST - Using paid EAS Build subscription"
    - echo "üîî INFO - Check build status at https://expo.dev"
  
  rules:
    # Only run if EXPO_TOKEN is configured
    - if: $EXPO_TOKEN
      when: manual
      allow_failure: true
  
  retry:
    max: 1
    when:
      - script_failure

# ============================================
# DEPLOY STAGE - EAS UPDATE (OTA - FREE)
# ============================================

update:eas:
  stage: deploy
  <<: *setup_pnpm
  cache: *cache_pnpm
  
  needs:
    - ci:lint-and-test
  
  variables:
    EAS_BRANCH: "preview"                          # Override with branch name
    UPDATE_MESSAGE: "OTA update from GitLab CI"    # Override with custom message
  
  script:
    - echo "üì¶ Installing dependencies..."
    - pnpm install --frozen-lockfile
    
    - echo "üîß Installing EAS CLI..."
    - pnpm add -g eas-cli
    
    - echo "üöÄ Publishing EAS Update..."
    - |
      eas update \
        --branch $EAS_BRANCH \
        --message "$UPDATE_MESSAGE" \
        --non-interactive
    
    - echo "‚úÖ OK - EAS Update published successfully"
    - echo "üåø BRANCH - $EAS_BRANCH"
    - echo "üí∞ COST - FREE (OTA updates are free)"
    - echo "üì± INFO - Users will receive update on next app launch"
  
  rules:
    # Auto-run on main branch if EXPO_TOKEN configured
    - if: $EXPO_TOKEN && $CI_COMMIT_BRANCH == "main"
    # Manual trigger on other branches
    - if: $EXPO_TOKEN
      when: manual
      allow_failure: true
  
  retry:
    max: 2
    when:
      - script_failure
