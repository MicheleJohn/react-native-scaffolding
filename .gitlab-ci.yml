# GitLab CI/CD for React Native Scaffolding
# Mirrors GitHub Actions functionality

image: node:22-alpine

# Stages definition
stages:
  - test
  - build
  - deploy

# Global cache configuration
.cache_config: &cache_config
  key:
    files:
      - pnpm-lock.yaml
  paths:
    - .pnpm-store
  policy: pull

# Global before_script for pnpm setup
.pnpm_setup: &pnpm_setup
  before_script:
    - corepack enable
    - corepack prepare --activate
    - pnpm config set store-dir .pnpm-store

# TEST STAGE
ci:lint-and-test:
  stage: test
  <<: *pnpm_setup
  cache:
    <<: *cache_config
    policy: pull-push
  script:
    - pnpm install --frozen-lockfile
    - |
      if [ ! -d "src/components/icons" ] || [ -z "$(ls -A src/components/icons 2>/dev/null)" ]; then
        echo "ERROR - Icon generation failed!"
        exit 1
      fi
      echo "OK - Icons generated successfully"
      ls -la src/components/icons/
    - pnpm run lint
    - pnpm run type-check
    - pnpm run format:check
    - pnpm run test:ci
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    paths:
      - coverage/
    expire_in: 7 days
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == "main"
    - if: $CI_COMMIT_BRANCH == "develop"

# BUILD STAGE - Web
build:web:
  stage: build
  <<: *pnpm_setup
  cache: *cache_config
  script:
    - pnpm install --frozen-lockfile
    - pnpm run build:web
    - echo "OK - Web build completed"
    - echo "BUILD - Size info"
    - du -sh dist/
  artifacts:
    name: "web-build-$CI_COMMIT_SHORT_SHA"
    paths:
      - dist/
    expire_in: 30 days
  rules:
    - if: $CI_COMMIT_BRANCH == "main"
    - when: manual
      allow_failure: true

# BUILD STAGE - Android
build:android:
  stage: build
  image: openjdk:17-slim
  cache:
    <<: *cache_config
    paths:
      - .pnpm-store
      - .gradle/wrapper
      - .gradle/caches
  variables:
    GRADLE_OPTS: "-Dorg.gradle.daemon=false"
  before_script:
    - apt-get update && apt-get install -y curl git
    - curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
    - apt-get install -y nodejs
    - corepack enable
    - corepack prepare --activate
    - pnpm config set store-dir .pnpm-store
  script:
    - pnpm install --frozen-lockfile
    - cd android
    - |
      if [ "$BUILD_TYPE" = "release" ]; then
        ./gradlew assembleRelease
      else
        ./gradlew assembleDebug
      fi
    - echo "OK - Android build completed"
    - echo "PLATFORM - Android"
    - echo "BUILD TYPE - ${BUILD_TYPE:-debug}"
    - echo "COST - FREE (GitLab CI minutes)"
  artifacts:
    name: "android-${BUILD_TYPE:-debug}-$CI_COMMIT_SHORT_SHA"
    paths:
      - android/app/build/outputs/apk/**/*.apk
    expire_in: 30 days
  rules:
    - when: manual
      allow_failure: true

# DEPLOY STAGE - EAS Build
build:eas:
  stage: deploy
  <<: *pnpm_setup
  cache: *cache_config
  variables:
    PLATFORM: "all"
    PROFILE: "preview"
  script:
    - pnpm install --frozen-lockfile
    - pnpm add -g eas-cli
    - |
      eas build \
        --platform $PLATFORM \
        --profile $PROFILE \
        --non-interactive \
        --no-wait
    - echo "OK - EAS Build triggered"
    - echo "PLATFORM - $PLATFORM"
    - echo "PROFILE - $PROFILE"
    - echo "COST - Using paid EAS subscription"
    - echo "INFO - Check build status at https://expo.dev"
  rules:
    - if: $EXPO_TOKEN
      when: manual
      allow_failure: true

# DEPLOY STAGE - EAS Update
update:eas:
  stage: deploy
  <<: *pnpm_setup
  cache: *cache_config
  variables:
    BRANCH: "preview"
    MESSAGE: "OTA update from GitLab CI"
  script:
    - pnpm install --frozen-lockfile
    - pnpm add -g eas-cli
    - |
      eas update \
        --branch $BRANCH \
        --message "$MESSAGE" \
        --non-interactive
    - echo "OK - EAS Update published"
    - echo "BRANCH - $BRANCH"
    - echo "INFO - Users will receive update on next app launch"
  rules:
    - if: $EXPO_TOKEN && $CI_COMMIT_BRANCH == "main"
    - if: $EXPO_TOKEN
      when: manual
      allow_failure: true
