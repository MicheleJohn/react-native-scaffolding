name: Mirror to GitLab (Branch-Safe)

# Push current branch to GitLab and create MR
# Does NOT force-push to main - merge happens on GitLab
on:
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'hotfix/**'
  workflow_dispatch:  # Allow manual trigger
    inputs:
      branch:
        description: 'Branch to mirror (leave empty for current)'
        required: false
        default: ''

jobs:
  mirror:
    name: Mirror Branch to GitLab
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history
          fetch-tags: true
      
      - name: Setup git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: Derive branch name
        id: vars
        run: |
          if [ -n "${{ github.event.inputs.branch }}" ]; then
            BRANCH="${{ github.event.inputs.branch }}"
          else
            BRANCH="${GITHUB_REF_NAME}"
          fi
          echo "BRANCH=${BRANCH}" >> $GITHUB_OUTPUT
          echo "üìå Mirroring branch: ${BRANCH}"
      
      - name: Add GitLab remote
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_URL: ${{ secrets.GITLAB_URL }}
        run: |
          # Extract host from URL (remove https:// and path)
          GITLAB_HOST=$(echo "${GITLAB_URL}" | sed -E 's|https?://([^/]+)/.*|\1|')
          GITLAB_PATH=$(echo "${GITLAB_URL}" | sed -E 's|https?://[^/]+/(.+)\.git$|\1|')
          
          echo "üîó GitLab host: ${GITLAB_HOST}"
          echo "üìÅ GitLab path: ${GITLAB_PATH}"
          
          # Add remote with OAuth2 token
          git remote add gitlab "https://oauth2:${GITLAB_TOKEN}@${GITLAB_HOST}/${GITLAB_PATH}.git"
      
      - name: Push current branch to GitLab
        env:
          BRANCH: ${{ steps.vars.outputs.BRANCH }}
        run: |
          echo "üì§ Pushing branch '${BRANCH}' to GitLab..."
          
          # Push only current branch (no --mirror, no --force to main)
          git push gitlab "HEAD:refs/heads/${BRANCH}" --force
          
          echo "‚úÖ Successfully pushed '${BRANCH}' to GitLab!"
      
      - name: Create or update Merge Request on GitLab
        # Only create MR for feature/* and hotfix/* branches
        if: startsWith(steps.vars.outputs.BRANCH, 'feature/') || startsWith(steps.vars.outputs.BRANCH, 'hotfix/')
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID }}
          GITLAB_HOST: ${{ secrets.GITLAB_HOST }}
          SOURCE_BRANCH: ${{ steps.vars.outputs.BRANCH }}
        run: |
          TARGET_BRANCH="main"
          TITLE="üîÑ Mirror: ${SOURCE_BRANCH} ‚Üí ${TARGET_BRANCH}"
          DESC="Automatic mirror from GitHub.
          
          **Source:** GitHub \`${SOURCE_BRANCH}\`
          **Target:** GitLab \`${TARGET_BRANCH}\`
          
          Review and approve this merge request on GitLab.
          
          ---
          
          ü§ñ Auto-generated by GitHub Actions"
          
          echo "üîç Checking for existing MR..."
          
          # Check if MR already exists
          EXISTING_MR=$(curl -sf --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            "https://${GITLAB_HOST}/api/v4/projects/${GITLAB_PROJECT_ID}/merge_requests?state=opened&source_branch=${SOURCE_BRANCH}&target_branch=${TARGET_BRANCH}" \
            | jq -r '.[0].iid // empty')
          
          if [ -n "${EXISTING_MR}" ]; then
            echo "üìù MR #${EXISTING_MR} exists - updating description"
            
            curl -sf --request PUT \
              --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
              --data-urlencode "description=${DESC}" \
              "https://${GITLAB_HOST}/api/v4/projects/${GITLAB_PROJECT_ID}/merge_requests/${EXISTING_MR}" \
              > /dev/null
            
            echo "‚úÖ Updated MR #${EXISTING_MR}"
            echo "üîó https://${GITLAB_HOST}/path/to/project/-/merge_requests/${EXISTING_MR}"
          else
            echo "üÜï Creating new MR: ${SOURCE_BRANCH} ‚Üí ${TARGET_BRANCH}"
            
            MR_RESPONSE=$(curl -sf --request POST \
              --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
              --data-urlencode "source_branch=${SOURCE_BRANCH}" \
              --data-urlencode "target_branch=${TARGET_BRANCH}" \
              --data-urlencode "title=${TITLE}" \
              --data-urlencode "description=${DESC}" \
              "https://${GITLAB_HOST}/api/v4/projects/${GITLAB_PROJECT_ID}/merge_requests")
            
            MR_IID=$(echo "${MR_RESPONSE}" | jq -r '.iid // empty')
            
            if [ -n "${MR_IID}" ]; then
              echo "‚úÖ Created MR #${MR_IID}"
              echo "üîó $(echo "${MR_RESPONSE}" | jq -r '.web_url')"
            else
              echo "‚ö†Ô∏è Failed to create MR"
              echo "Response: ${MR_RESPONSE}"
            fi
          fi
      
      - name: Summary
        if: always()
        env:
          BRANCH: ${{ steps.vars.outputs.BRANCH }}
        run: |
          echo ""
          echo "üìä Mirror Summary"
          echo "================="
          echo "‚úÖ Branch: ${BRANCH}"
          echo "üì¶ Pushed to GitLab"
          
          if [[ "${BRANCH}" == feature/* ]] || [[ "${BRANCH}" == hotfix/* ]]; then
            echo "üìù MR created/updated on GitLab"
            echo "‚ö†Ô∏è  Review and merge on GitLab!"
          else
            echo "‚ÑπÔ∏è  No MR created (${BRANCH} is not feature/hotfix)"
          fi
