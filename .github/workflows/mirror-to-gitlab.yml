name: Mirror to GitLab (Main Only)

# Push ONLY main branch from GitHub to GitLab
# Create MR for review on GitLab before final merge
on:
  push:
    branches:
      - main  # ONLY main branch
  workflow_dispatch:  # Allow manual trigger

jobs:
  mirror:
    name: Mirror Main to GitLab
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history
      
      - name: Setup git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
      
      - name: Extract GitLab info from URL
        id: gitlab
        env:
          GITLAB_URL: ${{ secrets.GITLAB_URL }}
        run: |
          # Extract host and project path from GITLAB_URL
          # Example: https://gitlab.com/company/project.git
          
          GITLAB_HOST=$(echo "${GITLAB_URL}" | sed -E 's|https?://([^/]+)/.*|\1|')
          GITLAB_PATH=$(echo "${GITLAB_URL}" | sed -E 's|https?://[^/]+/(.+)\.git$|\1|')
          
          echo "HOST=${GITLAB_HOST}" >> $GITHUB_OUTPUT
          echo "PATH=${GITLAB_PATH}" >> $GITHUB_OUTPUT
          
          echo "ğŸ“ GitLab host: ${GITLAB_HOST}"
          echo "ğŸ“ GitLab path: ${GITLAB_PATH}"
      
      - name: Push main to GitLab as github-main
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_HOST: ${{ steps.gitlab.outputs.HOST }}
          GITLAB_PATH: ${{ steps.gitlab.outputs.PATH }}
        run: |
          echo "ğŸ”— Adding GitLab remote..."
          git remote add gitlab "https://oauth2:${GITLAB_TOKEN}@${GITLAB_HOST}/${GITLAB_PATH}.git"
          
          echo "ğŸ“¤ Pushing main â†’ github-main on GitLab..."
          # Push GitHub main to GitLab as 'github-main' branch
          git push gitlab HEAD:refs/heads/github-main --force
          
          echo "âœ… Successfully pushed to GitLab!"
      
      - name: Create or update Merge Request on GitLab
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          GITLAB_PROJECT_ID: ${{ secrets.GITLAB_PROJECT_ID }}
          GITLAB_HOST: ${{ steps.gitlab.outputs.HOST }}
        run: |
          SOURCE_BRANCH="github-main"
          TARGET_BRANCH="main"
          TITLE="ğŸ”„ GitHub Main â†’ GitLab Main"
          DESC="Automatic sync from GitHub main branch.
          
          **Source:** GitHub \`main\` (pushed as \`github-main\`)
          **Target:** GitLab \`main\`
          
          Review and approve this merge request to sync changes.
          
          ---
          
          ğŸ¤– Auto-generated by GitHub Actions
          ğŸ“… $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          echo "ğŸ” Checking for existing MR..."
          
          # Check if MR already exists (github-main â†’ main)
          EXISTING_MR=$(curl -sf --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            "https://${GITLAB_HOST}/api/v4/projects/${GITLAB_PROJECT_ID}/merge_requests?state=opened&source_branch=${SOURCE_BRANCH}&target_branch=${TARGET_BRANCH}" \
            | jq -r '.[0].iid // empty' 2>/dev/null || echo "")
          
          if [ -n "${EXISTING_MR}" ]; then
            echo "ğŸ“ MR !${EXISTING_MR} exists - updating..."
            
            curl -sf --request PUT \
              --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
              --data-urlencode "description=${DESC}" \
              "https://${GITLAB_HOST}/api/v4/projects/${GITLAB_PROJECT_ID}/merge_requests/${EXISTING_MR}" \
              > /dev/null 2>&1
            
            echo "âœ… Updated MR !${EXISTING_MR}"
            echo "ğŸ”— https://${GITLAB_HOST}/${GITLAB_PATH}/-/merge_requests/${EXISTING_MR}"
          else
            echo "ğŸ†• Creating new MR: ${SOURCE_BRANCH} â†’ ${TARGET_BRANCH}"
            
            MR_RESPONSE=$(curl -sf --request POST \
              --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
              --data-urlencode "source_branch=${SOURCE_BRANCH}" \
              --data-urlencode "target_branch=${TARGET_BRANCH}" \
              --data-urlencode "title=${TITLE}" \
              --data-urlencode "description=${DESC}" \
              "https://${GITLAB_HOST}/api/v4/projects/${GITLAB_PROJECT_ID}/merge_requests" 2>/dev/null || echo '{}')
            
            MR_IID=$(echo "${MR_RESPONSE}" | jq -r '.iid // empty' 2>/dev/null || echo "")
            
            if [ -n "${MR_IID}" ]; then
              echo "âœ… Created MR !${MR_IID}"
              echo "ğŸ”— $(echo "${MR_RESPONSE}" | jq -r '.web_url' 2>/dev/null)"
            else
              echo "âš ï¸ Failed to create MR (might already exist or API error)"
              echo "Check manually: https://${GITLAB_HOST}/${GITLAB_PATH}/-/merge_requests"
            fi
          fi
      
      - name: Summary
        if: always()
        env:
          GITLAB_HOST: ${{ steps.gitlab.outputs.HOST }}
          GITLAB_PATH: ${{ steps.gitlab.outputs.PATH }}
        run: |
          echo ""
          echo "ğŸ“Š Mirror Summary"
          echo "=================="
          echo "âœ… Branch: main (GitHub) â†’ github-main (GitLab)"
          echo "ğŸ“ MR created/updated: github-main â†’ main"
          echo "âš ï¸  Review and merge on GitLab!"
          echo "ğŸ”— https://${GITLAB_HOST}/${GITLAB_PATH}/-/merge_requests"
